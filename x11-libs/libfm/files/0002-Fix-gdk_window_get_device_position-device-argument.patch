From 3355a737e0a4dcb87bda28868c30b70b1cd2eb34 Mon Sep 17 00:00:00 2001
From: Mamoru TASAKA <mtasaka@fedoraproject.org>
Date: Sat, 23 May 2015 15:51:55 +0900
Subject: [PATCH] Fix gdk_window_get_device_position device argument

http://sourceforge.net/p/pcmanfm/bugs/959/
---
 src/gtk-compat.h             | 2 ++
 src/gtk/fm-dnd-auto-scroll.c | 5 +++--
 src/gtk/fm-folder-view.c     | 5 +++--
 3 files changed, 8 insertions(+), 4 deletions(-)

diff --git a/src/gtk-compat.h b/src/gtk-compat.h
index 3f37fab..e460f74 100644
--- a/src/gtk-compat.h
+++ b/src/gtk-compat.h
@@ -33,6 +33,8 @@ G_BEGIN_DECLS
         gdk_window_get_pointer(win,xptr,yptr,mptr)
 #else
 #  define gdk_cursor_unref(obj) g_object_unref(obj)
+#  define GDK_GET_DEVICE_FROM_WINDOW(window) \
+        gdk_device_manager_get_client_pointer (gdk_display_get_device_manager (gdk_window_get_display(window)))
 #endif
 
 #if !GTK_CHECK_VERSION(2, 21, 0)
diff --git a/src/gtk/fm-dnd-auto-scroll.c b/src/gtk/fm-dnd-auto-scroll.c
index 72d866a..2861355 100644
--- a/src/gtk/fm-dnd-auto-scroll.c
+++ b/src/gtk/fm-dnd-auto-scroll.c
@@ -55,8 +55,9 @@ static gboolean on_auto_scroll(gpointer user_data)
     if(g_source_is_destroyed(g_main_current_source()))
         return FALSE;
 
-    gdk_window_get_device_position (gtk_widget_get_window(widget),
-                                    gtk_get_current_event_device(),
+    GdkWindow *window = gtk_widget_get_window(widget);
+    gdk_window_get_device_position (window,
+                                    GDK_GET_DEVICE_FROM_WINDOW(window),
                                     &x, &y, NULL);
     gtk_widget_get_allocation(widget, &allocation);
 
diff --git a/src/gtk/fm-folder-view.c b/src/gtk/fm-folder-view.c
index 21e7dff..8ee020e 100644
--- a/src/gtk/fm-folder-view.c
+++ b/src/gtk/fm-folder-view.c
@@ -1106,8 +1106,9 @@ static void popup_position_func(GtkMenu *menu, gint *x, gint *y,
     gtk_widget_realize(GTK_WIDGET(menu));
     /* get all the relative coordinates */
     gtk_widget_get_allocation(widget, &a);
-    gdk_window_get_device_position(gtk_widget_get_window(widget),
-                                   gtk_get_current_event_device(), &x2, &y2, NULL);
+    GdkWindow *window = gtk_widget_get_window(widget);
+    gdk_window_get_device_position(window,
+                                   GDK_GET_DEVICE_FROM_WINDOW(window), &x2, &y2, NULL);
     gtk_widget_get_allocation(GTK_WIDGET(menu), &ma);
     parent_window = gtk_widget_get_parent_window(widget);
     screen = gtk_widget_get_screen(widget);
-- 
2.4.1

